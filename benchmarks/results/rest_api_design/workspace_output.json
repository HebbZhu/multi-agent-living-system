{
  "plan": {
    "steps": [
      {
        "id": "step1",
        "title": "Define API Specification",
        "description": "List all REST API endpoints for the task management system including HTTP methods, paths, and request/response schemas for each endpoint.",
        "output_field": "api_specification"
      },
      {
        "id": "step2",
        "title": "Design Data Model",
        "description": "Define the Task entity with all necessary fields and their data types to be used in the application and API.",
        "output_field": "data_model"
      },
      {
        "id": "step3",
        "title": "Implement Flask Application",
        "description": "Develop a complete Flask application implementing all specified endpoints with in-memory storage, input validation, and JSON responses.",
        "output_field": "flask_implementation"
      },
      {
        "id": "step4",
        "title": "Add Error Handling",
        "description": "Incorporate proper HTTP status codes and a consistent error response format throughout the API for invalid input, not found resources, and other errors.",
        "output_field": "error_handling"
      }
    ]
  },
  "api_specification": "```python\n# step1: API Specification\n\napi_specification = {\n    \"endpoints\": [\n        {\n            \"method\": \"POST\",\n            \"path\": \"/tasks\",\n            \"description\": \"Create a new task\",\n            \"request_schema\": {\n                \"title\": \"string (required)\",\n                \"description\": \"string (optional)\"\n            },\n            \"response_schema\": {\n                \"id\": \"integer\",\n                \"title\": \"string\",\n                \"description\": \"string\",\n                \"completed\": \"boolean\"\n            },\n            \"status_codes\": [201, 400]\n        },\n        {\n            \"method\": \"GET\",\n            \"path\": \"/tasks\",\n            \"description\": \"List all tasks\",\n            \"request_schema\": None,\n            \"response_schema\": [\n                {\n                    \"id\": \"integer\",\n                    \"title\": \"string\",\n                    \"description\": \"string\",\n                    \"completed\": \"boolean\"\n                }\n            ],\n            \"status_codes\": [200]\n        },\n        {\n            \"method\": \"GET\",\n            \"path\": \"/tasks/{id}\",\n            \"description\": \"Get task by ID\",\n            \"request_schema\": None,\n            \"response_schema\": {\n                \"id\": \"integer\",\n                \"title\": \"string\",\n                \"description\": \"string\",\n                \"completed\": \"boolean\"\n            },\n            \"status_codes\": [200, 404]\n        },\n        {\n            \"method\": \"PUT\",\n            \"path\": \"/tasks/{id}\",\n            \"description\": \"Update task by ID\",\n            \"request_schema\": {\n                \"title\": \"string (optional)\",\n                \"description\": \"string (optional)\",\n                \"completed\": \"boolean (optional)\"\n            },\n            \"response_schema\": {\n                \"id\": \"integer\",\n                \"title\": \"string\",\n                \"description\": \"string\",\n                \"completed\": \"boolean\"\n            },\n            \"status_codes\": [200, 400, 404]\n        },\n        {\n            \"method\": \"DELETE\",\n            \"path\": \"/tasks/{id}\",\n            \"description\": \"Delete task by ID\",\n            \"request_schema\": None,\n            \"response_schema\": None,\n            \"status_codes\": [204, 404]\n        },\n        {\n            \"method\": \"POST\",\n            \"path\": \"/tasks/{id}/complete\",\n            \"description\": \"Mark task as complete\",\n            \"request_schema\": None,\n            \"response_schema\": {\n                \"id\": \"integer\",\n                \"title\": \"string\",\n                \"description\": \"string\",\n                \"completed\": \"boolean\"\n            },\n            \"status_codes\": [200, 404]\n        }\n    ]\n}\n\n# step2: Data Model\n\nfrom typing import Optional\nfrom dataclasses import dataclass, field\n\n@dataclass\nclass Task:\n    id: int\n    title: str\n    description: Optional[str] = \"\"\n    completed: bool = False\n\n# step3 and step4: Flask Implementation with Error Handling\n\nfrom flask import Flask, jsonify, request, abort\nfrom typing import Dict, Any, List, Union\nfrom werkzeug.exceptions import HTTPException\n\napp = Flask(__name__)\n\n# In-memory storage for tasks\ntasks: Dict[int, Task] = {}\nnext_id: int = 1\n\n\ndef task_to_dict(task: Task) -> Dict[str, Union[int, str, bool]]:\n    return {\n        \"id\": task.id,\n        \"title\": task.title,\n        \"description\": task.description,\n        \"completed\": task.completed,\n    }\n\n\ndef validate_task_creation(data: Dict[str, Any]) -> None:\n    if not isinstance(data, dict):\n        abort_json(400, \"Request body must be a JSON object\")\n    if \"title\" not in data:\n        abort_json(400, \"Missing required field: title\")\n    if not isinstance(data[\"title\"], str) or not data[\"title\"].strip():\n        abort_json(400, \"Field 'title' must be a non-empty string\")\n    if \"description\" in data and not isinstance(data[\"description\"], str):\n        abort_json(400, \"Field 'description' must be a string if provided\")\n\n\ndef validate_task_update(data: Dict[str, Any]) -> None:\n    if not isinstance(data, dict):\n        abort_json(400, \"Request body must be a JSON object\")\n    allowed_fields = {\"title\", \"description\", \"completed\"}\n    for key in data:\n        if key not in allowed_fields:\n            abort_json(400, f\"Invalid field: {key}\")\n    if \"title\" in data and (not isinstance(data[\"title\"], str) or not data[\"title\"].strip()):\n        abort_json(400, \"Field 'title' must be a non-empty string if provided\")\n    if \"description\" in data and not isinstance(data[\"description\"], str):\n        abort_json(400, \"Field 'description' must be a string if provided\")\n    if \"completed\" in data and not isinstance(data[\"completed\"], bool):\n        abort_json(400, \"Field 'completed' must be a boolean if provided\")\n\n\ndef abort_json(status_code: int, message: str) -> None:\n    response = jsonify({\"error\": message})\n    response.status_code = status_code\n    abort(response)\n\n\n@app.errorhandler(HTTPException)\ndef handle_http_exception(e: HTTPException):\n    response = e.get_response()\n    response.data = jsonify({\"error\": e.description}).data\n    response.content_type = \"application/json\"\n    return response\n\n\n@app.errorhandler(404)\ndef not_found(e):\n    return jsonify({\"error\": \"Resource not found\"}), 404\n\n\n@app.route(\"/tasks\", methods=[\"POST\"])\ndef create_task():\n    global next_id\n    data = request.get_json(force=True, silent=True)\n    if data is None:\n        abort_json(400, \"Invalid JSON\")\n    validate_task_creation(data)\n    task = Task(\n        id=next_id,\n        title=data[\"title\"].strip(),\n        description=data.get(\"description\", \"\").strip() if data.get(\"description\") else \"\",\n        completed=False,\n    )\n    tasks[next_id] = task\n    next_id += 1\n    return jsonify(task_to_dict(task)), 201\n\n\n@app.route(\"/tasks\", methods=[\"GET\"])\ndef list_tasks():\n    return jsonify([task_to_dict(task) for task in tasks.values()])\n\n\n@app.route(\"/tasks/<int:task_id>\", methods=[\"GET\"])\ndef get_task(task_id: int):\n    task = tasks.get(task_id)\n    if task is None:\n        abort_json(404, \"Task not found\")\n    return jsonify(task_to_dict(task))\n\n\n@app.route(\"/tasks/<int:task_id>\", methods=[\"PUT\"])\ndef update_task(task_id: int):\n    task = tasks.get(task_id)\n    if task is None:\n        abort_json(404, \"Task not found\")\n    data = request.get_json(force=True, silent=True)\n    if data is None:\n        abort_json(400, \"Invalid JSON\")\n    validate_task_update(data)\n    if \"title\" in data:\n        task.title = data[\"title\"].strip()\n    if \"description\" in data:\n        task.description = data[\"description\"].strip()\n    if \"completed\" in data:\n        task.completed = data[\"completed\"]\n    return jsonify(task_to_dict(task))\n\n\n@app.route(\"/tasks/<int:task_id>\", methods=[\"DELETE\"])\ndef delete_task(task_id: int):\n    if task_id not in tasks:\n        abort_json(404, \"Task not found\")\n    del tasks[task_id]\n    return \"\", 204\n\n\n@app.route(\"/tasks/<int:task_id>/complete\", methods=[\"POST\"])\ndef mark_task_complete(task_id: int):\n    task = tasks.get(task_id)\n    if task is None:\n        abort_json(404, \"Task not found\")\n    task.completed = True\n    return jsonify(task_to_dict(task))\n\n\nif __name__ == \"__main__\":\n    app.run(debug=False)\n```",
  "code": "```python\nfrom typing import Optional, List, Dict, Any\nfrom flask import Flask, request, jsonify, abort\nfrom flask.typing import ResponseReturnValue\nfrom uuid import uuid4\n\napp = Flask(__name__)\n\n# --- Data Model ---\n\nclass Task:\n    def __init__(self, title: str, description: Optional[str] = None) -> None:\n        self.id: str = str(uuid4())\n        self.title: str = title\n        self.description: Optional[str] = description\n        self.completed: bool = False\n\n    def to_dict(self) -> Dict[str, Any]:\n        return {\n            \"id\": self.id,\n            \"title\": self.title,\n            \"description\": self.description,\n            \"completed\": self.completed,\n        }\n\n    def update(self, data: Dict[str, Any]) -> None:\n        if \"title\" in data:\n            self.title = data[\"title\"]\n        if \"description\" in data:\n            self.description = data[\"description\"]\n        if \"completed\" in data:\n            self.completed = data[\"completed\"]\n\n\n# In-memory task storage\ntasks: Dict[str, Task] = {}\n\n# --- API Specification ---\n\n\"\"\"\nEndpoints:\n\n1. Create Task\n   - Method: POST\n   - Path: /tasks\n   - Request JSON:\n     {\n       \"title\": string (required),\n       \"description\": string (optional)\n     }\n   - Response JSON (201 Created):\n     {\n       \"id\": string,\n       \"title\": string,\n       \"description\": string or null,\n       \"completed\": bool\n     }\n\n2. List Tasks\n   - Method: GET\n   - Path: /tasks\n   - Response JSON (200 OK):\n     [\n       {\n         \"id\": string,\n         \"title\": string,\n         \"description\": string or null,\n         \"completed\": bool\n       },\n       ...\n     ]\n\n3. Get Task by ID\n   - Method: GET\n   - Path: /tasks/<id>\n   - Response JSON (200 OK):\n     {\n       \"id\": string,\n       \"title\": string,\n       \"description\": string or null,\n       \"completed\": bool\n     }\n   - Errors:\n     - 404 Not Found if task does not exist\n\n4. Update Task\n   - Method: PUT\n   - Path: /tasks/<id>\n   - Request JSON (any subset):\n     {\n       \"title\": string (optional),\n       \"description\": string (optional),\n       \"completed\": bool (optional)\n     }\n   - Response JSON (200 OK):\n     {\n       \"id\": string,\n       \"title\": string,\n       \"description\": string or null,\n       \"completed\": bool\n     }\n   - Errors:\n     - 400 Bad Request if no valid fields provided\n     - 404 Not Found if task does not exist\n\n5. Delete Task\n   - Method: DELETE\n   - Path: /tasks/<id>\n   - Response: 204 No Content\n   - Errors:\n     - 404 Not Found if task does not exist\n\n6. Mark Task as Complete\n   - Method: POST\n   - Path: /tasks/<id>/complete\n   - Response JSON (200 OK):\n     {\n       \"id\": string,\n       \"title\": string,\n       \"description\": string or null,\n       \"completed\": true\n     }\n   - Errors:\n     - 404 Not Found if task does not exist\n\"\"\"\n\n# --- Error Handling ---\n\ndef error_response(status_code: int, message: str) -> ResponseReturnValue:\n    response = jsonify({\"error\": message})\n    response.status_code = status_code\n    return response\n\n@app.errorhandler(404)\ndef not_found(error: Any) -> ResponseReturnValue:\n    return error_response(404, \"Resource not found\")\n\n@app.errorhandler(400)\ndef bad_request(error: Any) -> ResponseReturnValue:\n    return error_response(400, \"Bad request\")\n\n@app.errorhandler(405)\ndef method_not_allowed(error: Any) -> ResponseReturnValue:\n    return error_response(405, \"Method not allowed\")\n\n@app.errorhandler(500)\ndef internal_error(error: Any) -> ResponseReturnValue:\n    return error_response(500, \"Internal server error\")\n\n# --- Helper Functions ---\n\ndef get_task_or_404(task_id: str) -> Task:\n    task = tasks.get(task_id)\n    if task is None:\n        abort(404, description=\"Task not found\")\n    return task\n\ndef validate_task_payload(data: Dict[str, Any], require_title: bool = False) -> None:\n    if not isinstance(data, dict):\n        abort(400, description=\"Invalid JSON payload\")\n    if require_title and (\"title\" not in data or not isinstance(data[\"title\"], str) or not data[\"title\"].strip()):\n        abort(400, description=\"Field 'title' is required and must be a non-empty string\")\n    for key in data:\n        if key not in {\"title\", \"description\", \"completed\"}:\n            abort(400, description=f\"Unknown field '{key}' in payload\")\n    if \"completed\" in data and not isinstance(data[\"completed\"], bool):\n        abort(400, description=\"Field 'completed' must be a boolean\")\n\n# --- Routes ---\n\n@app.route(\"/tasks\", methods=[\"POST\"])\ndef create_task() -> ResponseReturnValue:\n    data = request.get_json(force=True, silent=True)\n    if data is None:\n        return error_response(400, \"Request body must be JSON\")\n    validate_task_payload(data, require_title=True)\n    title = data[\"title\"].strip()\n    description = data.get(\"description\")\n    if description is not None and not isinstance(description, str):\n        return error_response(400, \"Field 'description' must be a string or omitted\")\n    task = Task(title=title, description=description)\n    tasks[task.id] = task\n    return jsonify(task.to_dict()), 201\n\n@app.route(\"/tasks\", methods=[\"GET\"])\ndef list_tasks() -> ResponseReturnValue:\n    return jsonify([task.to_dict() for task in tasks.values()]), 200\n\n@app.route(\"/tasks/<string:task_id>\", methods=[\"GET\"])\ndef get_task(task_id: str) -> ResponseReturnValue:\n    task = get_task_or_404(task_id)\n    return jsonify(task.to_dict()), 200\n\n@app.route(\"/tasks/<string:task_id>\", methods=[\"PUT\"])\ndef update_task(task_id: str) -> ResponseReturnValue:\n    task = get_task_or_404(task_id)\n    data = request.get_json(force=True, silent=True)\n    if data is None:\n        return error_response(400, \"Request body must be JSON\")\n    if not any(field in data for field in (\"title\", \"description\", \"completed\")):\n        return error_response(400, \"At least one of 'title', 'description', or 'completed' must be provided\")\n    validate_task_payload(data, require_title=False)\n    if \"title\" in data:\n        if not isinstance(data[\"title\"], str) or not data[\"title\"].strip():\n            return error_response(400, \"Field 'title' must be a non-empty string\")\n        data[\"title\"] = data[\"title\"].strip()\n    if \"description\" in data and data[\"description\"] is not None and not isinstance(data[\"description\"], str):\n        return error_response(400, \"Field 'description' must be a string or null\")\n    task.update(data)\n    return jsonify(task.to_dict()), 200\n\n@app.route(\"/tasks/<string:task_id>\", methods=[\"DELETE\"])\ndef delete_task(task_id: str) -> ResponseReturnValue:\n    task = get_task_or_404(task_id)\n    del tasks[task.id]\n    return \"\", 204\n\n@app.route(\"/tasks/<string:task_id>/complete\", methods=[\"POST\"])\ndef mark_task_complete(task_id: str) -> ResponseReturnValue:\n    task = get_task_or_404(task_id)\n    task.completed = True\n    return jsonify(task.to_dict()), 200\n\n\nif __name__ == \"__main__\":\n    app.run(debug=False)\n```"
}